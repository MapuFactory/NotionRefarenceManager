{"files":[{"id":"129db30b-7bb3-49d8-9043-dcef1e41bb9c","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Tokyo\",\n  \"dependencies\": {\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"f157c419-4bc6-49a8-91f4-35373d2721cd","name":"コード","type":"server_js","source":"function Go2Notion() {\n  // NotionのAPIキーとデータベースID\n  var apiKey \u003d \u0027secret_8cqTbOraa1K4WYgwrZ3FjlaMJb988UCJqGtsoYKuJdg\u0027;\n  var databaseId \u003d \u00271fdfd8bdd22f49629fb0888319b28649\u0027;\n  var base_url \u003d \u0027https://api.notion.com/v1/databases/\u0027 + databaseId + \u0027/query\u0027;\n\n  // Notion APIにgetリクエストを送信\n  var options \u003d {\n    method: \u0027post\u0027,\n    headers: {\n      \u0027Authorization\u0027: \u0027Bearer \u0027 + apiKey,\n      \u0027Notion-Version\u0027: \u00272021-05-13\u0027\n    },\n  };\n\n  //NotionのDBを取得\n  var response \u003d UrlFetchApp.fetch(base_url, options);\n  var notion_data \u003d JSON.parse(response.getContentText());\n  var pages \u003d notion_data.results;\n\n  var notion_DOI \u003d pages.map(function(record) {\n    if (record.properties.DOI \u0026\u0026 record.properties.DOI.rich_text.length \u003e 0) {\n      return record.properties.DOI.rich_text[0].plain_text;\n    } else {\n      return null; // あるいは適切なデフォルト値\n    }\n  });\n\n  // newlist.jsonを取得\n  var file \u003d DriveApp.getFilesByName(\"newlist.json\").next();\n  var jsonDatas \u003d JSON.parse(file.getBlob().getDataAsString());\n  \n  const pdfFolderId\u003d \u00271s_irBlPMqiCxuR8wOJLqhCUBARyL_jWP\u0027; // 新規pdfファイル格納フォルダのID\n  var targetPDFs \u003d DriveApp.getFolderById(pdfFolderId); //新規pdfファイル群を取得\n  \n  var included_PDF_Folder_ID \u003d \u00271vHfmhzT3QL6QH0FsGQBx2M1a7vBuaXEe\u0027; //pdfの保存先\n  var goodNightPDFs \u003d DriveApp.getFolderById(included_PDF_Folder_ID);//pdfの保存先を取得\n\n  jsonDatas.forEach( jsonData \u003d\u003e {\n    file_name \u003d jsonData.file_name\n    console.log(file_name);\n    var pdfFiles \u003d targetPDFs.getFilesByName(file_name)\n    if(!pdfFiles.hasNext()){return;}\n    var pdfFile \u003d pdfFiles.next();//該当pdfを取得\n    //DOIを持たないファイルはスキップ\n    if(jsonData.doi \u003d\u003d null){\n      pdfFile.moveTo(goodNightPDFs);\n      return;\n    }\n    //そのDOIをもつデータが既に存在すればスキップ\n    if(notion_DOI.includes(\"https://doi.org/\" + jsonData.doi)){\n      pdfFile.setTrashed(true);\n      return;\n    }\n\n    // Crossref APIのURL（DOIをパラメータとして追加する）\n    var crossrefUrl \u003d \u0027https://api.crossref.org/works/\u0027 + jsonData.doi;\n\n    // Crossref APIにGETリクエストを送信\n    try {\n      var crossrefResponse \u003d UrlFetchApp.fetch(crossrefUrl);\n    } catch (error) {\n      console.error(\u0027Error fetching URL: \u0027 + crossrefUrl);\n      console.error(\u0027Error message: \u0027 + error.message);\n      return; // Skip the rest of this iteration and go to the next one\n    }\n    var crossrefData \u003d JSON.parse(crossrefResponse.getContentText());\n\n\n\n    // 必要な情報を取得\n    var title \u003d crossrefData.message.title[0];\n    var firstAuthor \u003d crossrefData.message.author[0].given + \u0027 \u0027 + crossrefData.message.author[0].family;\n    var issue \u003d crossrefData.message.issue || \"\";\n    var year \u003d crossrefData.message.created[\u0027date-parts\u0027][0][0] || \"\";\n    var pdf \u003d pdfFile.getDownloadUrl();\n    var authors \u003d crossrefData.message.author.map(function(author) {\n      return {\"name\": author.given + \u0027 \u0027 + author.family};\n    });\n    var publisher \u003d crossrefData.message.publisher || \"\";\n    var journal \u003d crossrefData.message[\u0027container-title\u0027][0] || \"\";\n    var edition \u003d crossrefData.message.edition || \"\";\n    var volume \u003d crossrefData.message.volume || \"\";\n    var pages \u003d crossrefData.message.page || \"\";\n    var doi \u003d jsonData.doi || \"\";\n    var type \u003d crossrefData.message.type || \"\";\n\n    // 新しいページのデータ\n    var pageData \u003d {\n      \"parent\": { \"database_id\": databaseId },\n      \"properties\": {\n        \"Name\": {\n          \"title\": [\n            {\n              \"text\": {\n                \"content\": title\n              }\n            }\n          ]\n        },\n        \"First\": {\n          \"select\": {\n            \"name\": firstAuthor // 実際の選択肢に置き換えてください。\n          }\n        },\n        \"Issue\": {\n          \"rich_text\" : [\n            {\n              \"text\": {\n                \"content\" : issue\n              }\n            }\n          ]\n        },\n        \"Year\": {\n          \"number\" : year\n        },\n        \"PDF\": {\n          \"rich_text\": [\n            {\n              \"text\": {\n                \"content\": pdf,\n                \"link\": {\n                  \"url\" : pdf\n                }\n              }\n            }\n          ]\n        },\n        \"Authors\": {\n          \"multi_select\" : authors\n        },\n        \"Publisher\": {\n          \"select\": {\n            \"name\": publisher\n          }\n        },\n        \"Journal\": {\n          \"select\": {\n            \"name\": journal\n          }\n        },\n        \"Edition\": {\n          \"rich_text\": [\n            {\n              \"text\": {\n                \"content\": edition\n              }\n            }\n          ]\n        },\n        \"Volume\": {\n          \"rich_text\" : [\n            {\n              \"text\": {\n                \"content\" : volume\n              }\n            }\n          ]\n        },\n        \"Pages\": {\n          \"rich_text\": [\n            {\n              \"text\": {\n                \"content\": pages\n              }\n            }\n          ]\n        },\n        \"DOI\": {\n          \"rich_text\": [\n            {\n              \"text\": {\n                \"content\": \"https://doi.org/\" + doi,\n                \"link\": {\n                  \"url\" : \"https://doi.org/\" + doi\n                }\n              }\n            }\n          ]\n        },\n        \"Type\": {\n          \"select\": {\n            \"name\": type\n          }\n        },\n      }\n    };\n    //console.log(pageData);  \n\n    var base_url \u003d \u0027https://api.notion.com/v1/pages\u0027;\n    // Notion APIにPOSTリクエストを送信\n    var options \u003d {\n      method: \u0027POST\u0027,\n      headers: {\n        \u0027Authorization\u0027: \u0027Bearer \u0027 + apiKey,\n        \u0027Notion-Version\u0027: \u00272021-05-13\u0027,\n        \u0027Content-Type\u0027: \u0027application/json\u0027\n      },\n      payload: JSON.stringify(pageData)\n    };\n    var response \u003d UrlFetchApp.fetch(base_url, options);\n    //pdfFile.moveTo(goodNightPDFs);\n  });\n  \n  file.setTrashed(true);\n  \n}\n\n"}]}